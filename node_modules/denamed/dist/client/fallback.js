"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.useFallback = void 0;
const dgram_1 = __importDefault(require("dgram"));
const decoder_1 = require("../core/decoder");
const encoding_1 = require("../core/encoding");
function useFallback(queryHandler, server) {
    const requestMap = new Map();
    const socket = dgram_1.default.createSocket("udp4");
    // TODO: Add error handling
    socket.on("error", console.error);
    socket.on("message", (message) => {
        try {
            const decoded = decoder_1.decodeMessage(message);
            const req = requestMap.get(decoded.id);
            if (req)
                req(null, decoded);
        }
        catch (e) {
            // TODO: Add error handling
            console.error(e);
        }
    });
    return async (query, source) => {
        const result = await queryHandler(query, source);
        if (!result) {
            return await new Promise((resolve, reject) => {
                requestMap.set(query.id, (err, message) => {
                    requestMap.delete(query.id);
                    if (err)
                        reject(err);
                    else
                        resolve(message);
                });
                socket.send(encoding_1.encodeMessage({ ...query, additional: undefined }), 53, server, (error) => {
                    if (error)
                        reject(error);
                });
            });
        }
        return result;
    };
}
exports.useFallback = useFallback;
//# sourceMappingURL=fallback.js.map